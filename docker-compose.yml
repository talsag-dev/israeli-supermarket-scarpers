services:
  clickhouse:
    image: clickhouse/clickhouse-server:23.8
    container_name: supermarket-clickhouse
    ports:
      - "8123:8123"
      - "9001:9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
    networks:
      - supermarket-network
    restart: unless-stopped
    ulimits:
      nofile:
        soft: 262144
        hard: 262144

  scraper:
    build:
      context: .
      target: prod
    container_name: supermarket-scraper
    command: uvicorn service:app --host 0.0.0.0 --port 8080
    ports:
      - "8080:8080"
    env_file:
      - .env
    environment:
      - CLICKHOUSE_HOST=clickhouse
      # Scraper configuration - if not set, scrapes ALL supermarkets
      # ENABLED_SCRAPERS: "BAREKET,YAYNO_BITAN,SHUFERSAL"
      # LIMIT: 10  # Uncomment to limit files per scraper
      # Optional: specify file types to scrape
      # ENABLED_FILE_TYPES: "STORE_FILE,PRICE_FILE"
    volumes:
      - ./dumps:/usr/src/app/dumps
    networks:
      - supermarket-network
    restart: unless-stopped
    depends_on:
      - clickhouse

  frontend:
    build:
      context: ./frontend
    container_name: supermarket-frontend
    ports:
      - "3000:80"
    environment:
      - VITE_API_URL=http://localhost:8080
    networks:
      - supermarket-network
    restart: unless-stopped
    depends_on:
      - scraper

volumes:
  clickhouse_data:
    driver: local

networks:
  supermarket-network:
    driver: bridge
